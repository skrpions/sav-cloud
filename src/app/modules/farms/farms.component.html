<div class="farms-layout">
  <!-- Sidebar -->
  <app-sidebar (itemClicked)="onSidebarItemClicked($event)"></app-sidebar>

  <!-- Contenido principal -->
  <div class="farms-content">
    <!-- Header -->
    <app-header></app-header>

    <!-- Contenedor principal -->
    <div class="farms-main">
      <!-- Panel de filtros y acciones -->
      <div class="farms-controls">
        <div class="controls-section">
          <h2 class="section-title">
            <mat-icon>agriculture</mat-icon>
            Gestión de Fincas
          </h2>
          
          <div class="actions-row">
            <!-- Filtros -->
            <div class="filters-container">
              <!-- Búsqueda -->
              <mat-form-field appearance="fill" class="filter-field">
                <mat-label>Buscar fincas...</mat-label>
                <input matInput 
                  [value]="searchTerm()" 
                  (input)="onSearchChanged($event)"
                  placeholder="Nombre, municipio, departamento...">
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>

              <!-- Filtro por departamento -->
              <mat-form-field appearance="fill" class="filter-field">
                <mat-label>Departamento</mat-label>
                <mat-select [(ngModel)]="filterDepartment" (ngModelChange)="updatePagination()">
                  <mat-option value="">Todos los departamentos</mat-option>
                  @for (dept of departmentOptions; track dept.value) {
                    <mat-option [value]="dept.value">{{ dept.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <!-- Botón limpiar filtros -->
              <button 
                mat-icon-button 
                (click)="clearFilters()"
                [disabled]="!hasFilters()"
                matTooltip="Limpiar filtros"
                class="clear-filters-btn">
                <mat-icon>close</mat-icon>
              </button>
            </div>

            <!-- Botones de vista -->
            <div class="view-toggle-buttons">
              <button 
                mat-icon-button 
                [class.active]="viewMode() === 'list'"
                (click)="switchView('list')"
                matTooltip="Vista de Lista"
                class="view-toggle-btn">
                <mat-icon>list</mat-icon>
              </button>
              <button 
                mat-icon-button 
                [class.active]="viewMode() === 'cards'"
                (click)="switchView('cards')"
                matTooltip="Vista de Tarjetas"
                class="view-toggle-btn">
                <mat-icon>view_module</mat-icon>
              </button>
            </div>

            <!-- Botón nueva finca -->
            <button 
              mat-raised-button 
              color="primary" 
              (click)="openSidePanel()"
              class="add-farm-btn">
              <mat-icon>add</mat-icon>
              Nueva Finca
            </button>
          </div>
        </div>
      </div>

      <!-- Vista de Lista (tabla) -->
      @if (viewMode() === 'list') {
        <div class="farms-list-view">
          <!-- Loading spinner -->
          @if (isLoading()) {
            <div class="loading-container">
              <mat-spinner></mat-spinner>
              <p>Cargando fincas...</p>
            </div>
          }

          <!-- Lista de fincas -->
          @if (!isLoading()) {
            <div class="farms-list">
              <!-- Mensaje cuando no hay fincas -->
              @if (filteredFarms.length === 0) {
                <div class="no-farms-message">
                  <mat-icon>info</mat-icon>
                  <h3>No hay fincas registradas</h3>
                  @if (!hasFilters()) {
                    <p>Comienza registrando tu primera finca</p>
                  }
                  @if (hasFilters()) {
                    <p>No se encontraron fincas con los filtros aplicados</p>
                  }
                  @if (!hasFilters()) {
                    <app-action-button
                      variant="primary"
                      icon="add"
                      label="Registrar Primera Finca"
                      (buttonClick)="openSidePanel()">
                    </app-action-button>
                  }
                </div>
              }

              <!-- Tabla de fincas -->
              @if (filteredFarms.length > 0) {
                <div class="farms-table-container">
                  <table mat-table [dataSource]="paginatedFarms" class="farms-table">
                    <!-- Nombre -->
                    <ng-container matColumnDef="name">
                      <th mat-header-cell *matHeaderCellDef class="header-cell">Finca</th>
                      <td mat-cell *matCellDef="let farm" class="data-cell">
                        <div class="farm-info">
                          <div class="farm-name">{{ farm.name }}</div>
                          @if (farm.description) {
                            <div class="farm-description">{{ farm.description }}</div>
                          }
                        </div>
                      </td>
                    </ng-container>

                    <!-- Ubicación -->
                    <ng-container matColumnDef="location">
                      <th mat-header-cell *matHeaderCellDef class="header-cell">Ubicación</th>
                      <td mat-cell *matCellDef="let farm" class="data-cell">
                        <div class="location-info">
                          @if (farm.municipality) {
                            <div>{{ farm.municipality }}</div>
                          }
                          @if (farm.department) {
                            <div>{{ farm.department }}</div>
                          }
                        </div>
                      </td>
                    </ng-container>

                    <!-- Área -->
                    <ng-container matColumnDef="area">
                      <th mat-header-cell *matHeaderCellDef class="header-cell">Área</th>
                      <td mat-cell *matCellDef="let farm" class="data-cell">
                        <span class="area-value">{{ formatArea(farm.total_area) }}</span>
                      </td>
                    </ng-container>

                    <!-- Altitud -->
                    <ng-container matColumnDef="altitude">
                      <th mat-header-cell *matHeaderCellDef class="header-cell">Altitud</th>
                      <td mat-cell *matCellDef="let farm" class="data-cell">
                        <span class="altitude-value">{{ formatAltitudeRange(farm.altitude_min, farm.altitude_max) }}</span>
                      </td>
                    </ng-container>

                    <!-- Certificaciones -->
                    <ng-container matColumnDef="certifications">
                      <th mat-header-cell *matHeaderCellDef class="header-cell">Certificaciones</th>
                      <td mat-cell *matCellDef="let farm" class="data-cell">
                        <div class="certifications-list">
                          @for (cert of getCertificationsList(farm.certifications); track cert) {
                            <span class="certification-badge">{{ cert }}</span>
                          }
                          @if (getCertificationsList(farm.certifications).length === 0) {
                            <span class="no-certifications">Sin certificaciones</span>
                          }
                        </div>
                      </td>
                    </ng-container>

                    <!-- Acciones -->
                    <ng-container matColumnDef="actions">
                      <th mat-header-cell *matHeaderCellDef class="header-cell actions-header">Acciones</th>
                      <td mat-cell *matCellDef="let farm" class="data-cell actions-cell">
                        <div class="action-buttons">
                          <button 
                            mat-icon-button 
                            matTooltip="Editar"
                            class="action-btn edit-btn"
                            (click)="openSidePanel(farm)">
                            <mat-icon>edit</mat-icon>
                          </button>
                          <button 
                            mat-icon-button 
                            matTooltip="Eliminar"
                            class="action-btn delete-btn"
                            (click)="onDeleteFarm(farm)">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </div>
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="['name', 'location', 'area', 'altitude', 'certifications', 'actions']"></tr>
                    <tr mat-row *matRowDef="let row; columns: ['name', 'location', 'area', 'altitude', 'certifications', 'actions']"></tr>
                  </table>

                  <!-- Paginación -->
                  @if (totalPages() > 1) {
                    <div class="pagination-container">
                      <div class="pagination-info">
                        <span>Página {{ currentPage() + 1 }} de {{ totalPages() }}</span>
                        <span class="total-records">({{ filteredFarms.length }} fincas)</span>
                      </div>
                      
                      <div class="pagination-controls">
                        <button 
                          mat-icon-button 
                          [disabled]="currentPage() === 0"
                          (click)="prevPage()"
                          matTooltip="Página anterior">
                          <mat-icon>chevron_left</mat-icon>
                        </button>
                        
                        <div class="page-numbers">
                          @for (page of [].constructor(totalPages()); track $index; let i = $index) {
                            <button 
                              mat-button
                              [class.active]="i === currentPage()"
                              (click)="changePage(i)"
                              class="page-btn">
                              {{ i + 1 }}
                            </button>
                          }
                        </div>
                        
                        <button 
                          mat-icon-button 
                          [disabled]="currentPage() >= totalPages() - 1"
                          (click)="nextPage()"
                          matTooltip="Página siguiente">
                          <mat-icon>chevron_right</mat-icon>
                        </button>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- Vista de Tarjetas -->
      @if (viewMode() === 'cards') {
        <div class="farms-cards-view">
          <!-- Loading spinner -->
          @if (isLoading()) {
            <div class="loading-container">
              <mat-spinner></mat-spinner>
              <p>Cargando fincas...</p>
            </div>
          }

          <!-- Lista de fincas -->
          @if (!isLoading()) {
            <div class="farms-list">
              <!-- Mensaje cuando no hay fincas -->
              @if (filteredFarms.length === 0) {
                <div class="no-farms-message">
                  <mat-icon>info</mat-icon>
                  <h3>No hay fincas registradas</h3>
                  @if (!hasFilters()) {
                    <p>Comienza registrando tu primera finca</p>
                  }
                  @if (hasFilters()) {
                    <p>No se encontraron fincas con los filtros aplicados</p>
                  }
                  @if (!hasFilters()) {
                    <app-action-button
                      variant="primary"
                      icon="add"
                      label="Registrar Primera Finca"
                      (buttonClick)="openSidePanel()">
                    </app-action-button>
                  }
                </div>
              }

              <!-- Cards de fincas -->
              <div class="farms-cards-grid">
                @for (farm of paginatedFarms; track trackByFarmId($index, farm)) {
                  <div class="farm-card">
                    <div class="card-header">
                      <div class="farm-name">{{ farm.name }}</div>
                      <div class="farm-actions">
                        <button 
                          mat-icon-button 
                          matTooltip="Editar"
                          class="action-btn edit-btn"
                          (click)="openSidePanel(farm)">
                          <mat-icon>edit</mat-icon>
                        </button>
                        <button 
                          mat-icon-button 
                          matTooltip="Eliminar"
                          class="action-btn delete-btn"
                          (click)="onDeleteFarm(farm)">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </div>
                    </div>

                    <div class="card-content">
                      @if (farm.description) {
                        <div class="farm-description">
                          {{ farm.description }}
                        </div>
                      }

                      <div class="farm-details">
                        @if (farm.municipality || farm.department) {
                          <div class="detail-item">
                            <mat-icon>location_on</mat-icon>
                            <div class="detail-content">
                              <div class="detail-label">Ubicación</div>
                              <div class="detail-value">
                                {{ getLocationString(farm) }}
                              </div>
                            </div>
                          </div>
                        }

                        @if (farm.total_area) {
                          <div class="detail-item">
                            <mat-icon>landscape</mat-icon>
                            <div class="detail-content">
                              <div class="detail-label">Área Total</div>
                              <div class="detail-value">{{ formatArea(farm.total_area) }}</div>
                            </div>
                          </div>
                        }

                        @if (farm.altitude_min || farm.altitude_max) {
                          <div class="detail-item">
                            <mat-icon>terrain</mat-icon>
                            <div class="detail-content">
                              <div class="detail-label">Altitud</div>
                              <div class="detail-value">{{ formatAltitudeRange(farm.altitude_min, farm.altitude_max) }}</div>
                            </div>
                          </div>
                        }

                        @if (farm.established_date) {
                          <div class="detail-item">
                            <mat-icon>calendar_today</mat-icon>
                            <div class="detail-content">
                              <div class="detail-label">Establecida</div>
                              <div class="detail-value">{{ formatDate(farm.established_date) }}</div>
                            </div>
                          </div>
                        }
                      </div>

                      @if (getCertificationsList(farm.certifications).length > 0) {
                        <div class="certifications-section">
                          <div class="certifications-label">Certificaciones:</div>
                          <div class="certifications-list">
                            @for (cert of getCertificationsList(farm.certifications); track cert) {
                              <span class="certification-badge">{{ cert }}</span>
                            }
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>

              <!-- Paginación para cards -->
              @if (totalPages() > 1) {
                <div class="pagination-container">
                  <div class="pagination-info">
                    <span>Página {{ currentPage() + 1 }} de {{ totalPages() }}</span>
                    <span class="total-records">({{ filteredFarms.length }} fincas)</span>
                  </div>
                  
                  <div class="pagination-controls">
                    <button 
                      mat-icon-button 
                      [disabled]="currentPage() === 0"
                      (click)="prevPage()"
                      matTooltip="Página anterior">
                      <mat-icon>chevron_left</mat-icon>
                    </button>
                    
                    <div class="page-numbers">
                      @for (page of [].constructor(totalPages()); track $index; let i = $index) {
                        <button 
                          mat-button
                          [class.active]="i === currentPage()"
                          (click)="changePage(i)"
                          class="page-btn">
                          {{ i + 1 }}
                        </button>
                      }
                    </div>
                    
                    <button 
                      mat-icon-button 
                      [disabled]="currentPage() >= totalPages() - 1"
                      (click)="nextPage()"
                      matTooltip="Página siguiente">
                      <mat-icon>chevron_right</mat-icon>
                    </button>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  </div>

  <!-- Panel lateral para crear/editar finca -->
  @if (showSidePanel()) {
    <div class="side-panel open">
      <div class="side-panel-content">
        <!-- Header del panel -->
        <div class="panel-header">
          <h2>
            <mat-icon>{{ isEditMode() ? 'edit' : 'add' }}</mat-icon>
            {{ isEditMode() ? 'Editar Finca' : 'Nueva Finca' }}
          </h2>
          <button mat-icon-button (click)="closeSidePanel()" class="close-btn">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <!-- Formulario -->
        <div class="form-container">
          <form [formGroup]="farmForm" (ngSubmit)="onSaveFarm()" class="farm-form">
            <!-- Errores del formulario -->
            @if (formSubmitted() && farmForm.errors) {
              <div class="form-errors">
                <mat-icon>error</mat-icon>
                <div class="error-messages">
                  @if (farmForm.errors['coordinatesIncomplete']) {
                    <p>{{ getFieldError('') }}</p>
                  }
                  @if (farmForm.errors['invalidColombianCoordinates']) {
                    <p>{{ getFieldError('') }}</p>
                  }
                  @if (farmForm.errors['invalidAltitudeRange']) {
                    <p>{{ getFieldError('') }}</p>
                  }
                </div>
              </div>
            }
            
            <div class="form-content">
              <!-- Layout de dos columnas -->
              <div class="form-columns">
                <!-- Columna izquierda -->
                <div class="form-column">
                  <!-- Información básica -->
                  <div class="form-section">
                    <h3 class="section-title">
                      <mat-icon>info</mat-icon>
                      Información Básica
                    </h3>
                    
                    <mat-form-field appearance="fill" class="form-field">
                      <mat-label>Nombre de la Finca *</mat-label>
                      <input matInput formControlName="name" required>
                      @if (isFieldInvalid('name')) {
                        <mat-error>{{ getFieldError('name') }}</mat-error>
                      }
                    </mat-form-field>

                    <mat-form-field appearance="fill" class="form-field">
                      <mat-label>Descripción</mat-label>
                      <textarea matInput formControlName="description" rows="2" placeholder="Descripción breve..."></textarea>
                      @if (isFieldInvalid('description')) {
                        <mat-error>{{ getFieldError('description') }}</mat-error>
                      }
                    </mat-form-field>
                  </div>

                  <!-- Ubicación -->
                  <div class="form-section">
                    <h3 class="section-title">
                      <mat-icon>place</mat-icon>
                      Ubicación
                    </h3>
                    
                    <mat-form-field appearance="fill" class="form-field">
                      <mat-label>Dirección</mat-label>
                      <input matInput formControlName="address">
                      @if (isFieldInvalid('address')) {
                        <mat-error>{{ getFieldError('address') }}</mat-error>
                      }
                    </mat-form-field>

                    <div class="form-row">
                      <mat-form-field appearance="fill" class="form-field half-width">
                        <mat-label>Municipio</mat-label>
                        <input matInput formControlName="municipality">
                        @if (isFieldInvalid('municipality')) {
                          <mat-error>{{ getFieldError('municipality') }}</mat-error>
                        }
                      </mat-form-field>

                      <mat-form-field appearance="fill" class="form-field half-width">
                        <mat-label>Departamento</mat-label>
                        <mat-select formControlName="department">
                          @for (dept of departmentOptions; track dept.value) {
                            <mat-option [value]="dept.value">{{ dept.label }}</mat-option>
                          }
                        </mat-select>
                        @if (isFieldInvalid('department')) {
                          <mat-error>{{ getFieldError('department') }}</mat-error>
                        }
                      </mat-form-field>
                    </div>

                    <mat-form-field appearance="fill" class="form-field">
                      <mat-label>País</mat-label>
                      <input matInput formControlName="country" readonly>
                    </mat-form-field>
                  </div>

                  <!-- Características físicas -->
                  <div class="form-section">
                    <h3 class="section-title">
                      <mat-icon>terrain</mat-icon>
                      Características
                    </h3>
                    
                    <mat-form-field appearance="fill" class="form-field">
                      <mat-label>Área Total</mat-label>
                      <input matInput type="number" formControlName="total_area" min="0" step="0.1">
                      <span matSuffix>hectáreas</span>
                      @if (isFieldInvalid('total_area')) {
                        <mat-error>{{ getFieldError('total_area') }}</mat-error>
                      }
                    </mat-form-field>

                    <div class="form-row">
                      <mat-form-field appearance="fill" class="form-field half-width">
                        <mat-label>Altitud Mínima</mat-label>
                        <input matInput type="number" formControlName="altitude_min" min="0">
                        <span matSuffix>m.s.n.m.</span>
                        @if (isFieldInvalid('altitude_min')) {
                          <mat-error>{{ getFieldError('altitude_min') }}</mat-error>
                        }
                      </mat-form-field>

                      <mat-form-field appearance="fill" class="form-field half-width">
                        <mat-label>Altitud Máxima</mat-label>
                        <input matInput type="number" formControlName="altitude_max" min="0">
                        <span matSuffix>m.s.n.m.</span>
                        @if (isFieldInvalid('altitude_max')) {
                          <mat-error>{{ getFieldError('altitude_max') }}</mat-error>
                        }
                      </mat-form-field>
                    </div>
                  </div>
                </div>

                <!-- Columna derecha -->
                <div class="form-column">
                  <!-- Coordenadas -->
                  <div class="form-section">
                    <h3 class="section-title">
                      <mat-icon>my_location</mat-icon>
                      Coordenadas
                    </h3>
                    
                    <div class="form-row">
                      <mat-form-field appearance="fill" class="form-field half-width">
                        <mat-label>Latitud</mat-label>
                        <input matInput type="number" formControlName="latitude" step="0.000001">
                        @if (isFieldInvalid('latitude')) {
                          <mat-error>{{ getFieldError('latitude') }}</mat-error>
                        }
                      </mat-form-field>

                      <mat-form-field appearance="fill" class="form-field half-width">
                        <mat-label>Longitud</mat-label>
                        <input matInput type="number" formControlName="longitude" step="0.000001">
                        @if (isFieldInvalid('longitude')) {
                          <mat-error>{{ getFieldError('longitude') }}</mat-error>
                        }
                      </mat-form-field>
                    </div>
                  </div>

                  <!-- Contacto -->
                  <div class="form-section">
                    <h3 class="section-title">
                      <mat-icon>contact_phone</mat-icon>
                      Contacto
                    </h3>
                    
                    <div class="form-row">
                      <mat-form-field appearance="fill" class="form-field">
                        <mat-label>Fecha de Establecimiento</mat-label>
                        <input matInput [matDatepicker]="establishedDatePicker" formControlName="established_date">
                        <mat-datepicker-toggle matSuffix [for]="establishedDatePicker"></mat-datepicker-toggle>
                        <mat-datepicker #establishedDatePicker></mat-datepicker>
                      </mat-form-field>

                      <mat-form-field appearance="fill" class="form-field half-width">
                        <mat-label>Teléfono</mat-label>
                        <input matInput formControlName="phone" placeholder="+57 300 123 4567">
                        @if (isFieldInvalid('phone')) {
                          <mat-error>{{ getFieldError('phone') }}</mat-error>
                        }
                      </mat-form-field>
                    </div>

                    <mat-form-field appearance="fill" class="form-field half-width">
                      <mat-label>Email</mat-label>
                      <input matInput type="email" formControlName="email">
                      @if (isFieldInvalid('email')) {
                        <mat-error>{{ getFieldError('email') }}</mat-error>
                      }
                    </mat-form-field>
                  </div>

                  <!-- Certificaciones -->
                  <div class="form-section" formGroupName="certifications">
                    <h3 class="section-title">
                      <mat-icon>verified</mat-icon>
                      Certificaciones
                    </h3>
                    
                    <div class="certifications-grid">
                      @for (cert of certificationOptions; track cert.key) {
                        <mat-checkbox [formControlName]="cert.key" class="certification-checkbox">
                          <div class="certification-info">
                            <div class="certification-label">{{ cert.label }}</div>
                            <div class="certification-description">{{ cert.description }}</div>
                          </div>
                        </mat-checkbox>
                      }
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-actions">
              <app-action-button
                variant="secondary"
                icon="close"
                label="Cancelar"
                (buttonClick)="closeSidePanel()">
              </app-action-button>
              <app-action-button
                variant="primary"
                [icon]="isLoading() ? 'hourglass_empty' : 'save'"
                [label]="(isEditMode() ? 'Actualizar' : 'Crear') + ' Finca'"
                [disabled]="(!formSubmitted() && farmForm.untouched) || (formSubmitted() && farmForm.invalid) || isLoading()"
                [loading]="isLoading()"
                type="submit"
                (buttonClick)="onSaveFarm()">
              </app-action-button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }

  <!-- Overlay para cerrar panel -->
  @if (showSidePanel()) {
    <div 
      class="panel-overlay visible" 
      (click)="closeSidePanel()"
      tabindex="0"
      role="button"
      aria-label="Cerrar panel lateral"
      [attr.aria-hidden]="!showSidePanel()">
    </div>
  }
</div> 